# BulC Homepage 테이블 정의서

> 최종 업데이트: 2024-12-22
> PostgreSQL 16

## 테이블 목록

| No | 테이블명 | 설명 | 분류 |
|----|----------|------|------|
| 1 | user_roles | 유저 등급 테이블 | 사용자 |
| 2 | users | 유저 테이블 | 사용자 |
| 3 | email_verifications | 이메일 인증 테이블 | 사용자 |
| 4 | products | 상품 종류 테이블 | 결제 |
| 5 | price_plans | 상품 가격 테이블 | 결제 |
| 6 | subscriptions | 유저 구독 관리 테이블 | 결제 |
| 7 | payments | 결제 테이블 | 결제 |
| 8 | activity_logs | 활동 로그 테이블 | 로그 |
| 9 | user_change_logs | 유저 정보 변경 로그 테이블 | 로그 |
| 10 | admin_logs | 관리자 로그 테이블 | 로그 |
| 11 | license_plans | 라이선스 플랜 테이블 | 라이선스 |
| 12 | license_plan_entitlements | 플랜 기능 권한 테이블 | 라이선스 |
| 13 | licenses | 라이선스 테이블 | 라이선스 |
| 14 | license_activations | 라이선스 활성화 테이블 | 라이선스 |
| 15 | revoked_offline_tokens | 무효화된 오프라인 토큰 테이블 | 라이선스 |

---

## 1. user_roles (유저 등급 테이블)

사용자 권한 등급을 정의하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | code | VARCHAR(10) | NO | - | 역할 코드 (PK) |
| 2 | role | VARCHAR(50) | NO | - | 역할명 |

**기본 등급 데이터**
| code | role | 설명 |
|------|------|------|
| 000 | admin | 관리자 |
| 001 | manager | 매니저 |
| 002 | user | 일반 사용자 |

---

## 2. users (유저 테이블)

사용자 기본 정보를 저장하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | email | VARCHAR(255) | NO | - | 이메일 (PK, 로그인 ID) |
| 2 | password_hash | VARCHAR(255) | NO | - | 비밀번호 해시 |
| 3 | roles_code | VARCHAR(10) | NO | '002' | 역할 코드 FK → user_roles.code |
| 4 | name | VARCHAR(100) | YES | - | 이름 (결제 시 입력) |
| 5 | phone | VARCHAR(20) | YES | - | 전화번호 (결제 시 입력) |
| 6 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 생성일시 |
| 7 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 수정일시 |

---

## 3. email_verifications (이메일 인증 테이블)

이메일 인증 코드를 관리하는 테이블 (인증 완료 시 레코드 삭제)

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | id | BIGINT | NO | AUTO | 기본키 |
| 2 | email | VARCHAR(255) | NO | - | 인증할 이메일 (UNIQUE) |
| 3 | verification_code | VARCHAR(6) | NO | - | 6자리 인증 코드 |
| 4 | expires_at | TIMESTAMP | NO | - | 인증 코드 만료 시각 |
| 5 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 생성일시 |

---

## 4. products (상품 종류 테이블)

판매 상품을 정의하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | code | VARCHAR(3) | NO | - | 상품 코드 (PK, 000~999) |
| 2 | name | VARCHAR(255) | NO | - | 상품명 |
| 3 | description | TEXT | YES | - | 상품 설명 |
| 4 | is_active | BOOLEAN | NO | TRUE | 활성화 여부 |
| 5 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 생성일시 |
| 6 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 수정일시 |

**기본 상품 데이터**
| code | name | description |
|------|------|-------------|
| 001 | BULC | 화재시뮬레이션 |

---

## 5. price_plans (상품 가격 테이블)

상품별 요금제를 정의하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | id | BIGINT | NO | AUTO | 기본키 |
| 2 | product_code | VARCHAR(3) | NO | - | 상품 FK → products.code |
| 3 | name | VARCHAR(100) | NO | - | 요금제명 |
| 4 | price | DECIMAL(18,2) | NO | - | 가격 |
| 5 | currency | VARCHAR(10) | NO | 'KRW' | 통화 |
| 6 | is_active | BOOLEAN | NO | TRUE | 활성화 여부 |
| 7 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 생성일시 |
| 8 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 수정일시 |

---

## 6. subscriptions (유저 구독 관리 테이블)

사용자의 구독 현황을 관리하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | id | BIGINT | NO | AUTO | 기본키 |
| 2 | user_email | VARCHAR(255) | YES | - | 유저 FK → users.email |
| 3 | product_code | VARCHAR(3) | NO | - | 상품 FK → products.code |
| 4 | price_plan_id | BIGINT | NO | - | 요금제 FK → price_plans.id |
| 5 | status | CHAR(1) | NO | 'A' | 구독 상태 |
| 6 | start_date | TIMESTAMP | NO | - | 구독 시작일 |
| 7 | end_date | TIMESTAMP | NO | - | 구독 종료일 |
| 8 | auto_renew | BOOLEAN | NO | FALSE | 자동 갱신 여부 |
| 9 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 생성일시 |
| 10 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 수정일시 |

**구독 상태 (status)**
- `A`: 활성 (Active)
- `E`: 만료 (Expired)
- `C`: 취소 (Canceled)

---

## 7. payments (결제 테이블)

결제 및 환불 정보를 관리하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | id | BIGINT | NO | AUTO | 기본키 |
| 2 | user_email_fk | VARCHAR(255) | YES | - | 유저 FK → users.email |
| 3 | user_email | VARCHAR(255) | NO | - | 결제 시점 이메일 |
| 4 | user_name | VARCHAR(100) | YES | - | 결제 시점 이름 |
| 5 | subscription_id | BIGINT | YES | - | 구독 FK → subscriptions.id |
| 6 | price_plan_id | BIGINT | YES | - | 요금제 FK → price_plans.id |
| 7 | amount | DECIMAL(18,2) | NO | - | 결제 금액 |
| 8 | currency | VARCHAR(10) | NO | 'KRW' | 통화 |
| 9 | status | CHAR(1) | NO | 'P' | 결제 상태 |
| 10 | order_name | VARCHAR(255) | YES | - | 주문명 |
| 11 | paid_at | TIMESTAMP | YES | - | 결제 완료 시각 |
| 12 | refunded_at | TIMESTAMP | YES | - | 환불 시각 |
| 13 | refund_amount | DECIMAL(18,2) | YES | - | 환불 금액 |
| 14 | refund_reason | TEXT | YES | - | 환불 사유 |
| 15 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 생성일시 |
| 16 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 수정일시 |

**결제 상태 (status)**
- `P`: 대기 (Pending)
- `C`: 완료 (Completed)
- `F`: 실패 (Failed)
- `R`: 환불 (Refunded)

---

## 8. payment_details (결제 상세 테이블)

PG사 연동 정보를 저장하는 테이블 (payments와 1:1 관계)

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | payment_id | BIGINT | NO | - | 결제 FK/PK → payments.id |
| 2 | payment_method | VARCHAR(50) | YES | - | 결제 수단 (card/bank/kakao) |
| 3 | payment_provider | VARCHAR(50) | YES | - | PG사 (toss) |
| 4 | order_id | VARCHAR(100) | YES | - | 가맹점 주문 ID |
| 5 | payment_key | VARCHAR(255) | YES | - | 토스페이먼츠 결제 키 |
| 6 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 생성일시 |
| 7 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 수정일시 |

---

## 9. activity_logs (활동 로그 테이블)

로그인, 구매, 환불 등 사용자 활동을 기록하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | id | BIGINT | NO | AUTO | 기본키 |
| 2 | user_email | VARCHAR(255) | YES | - | 유저 FK -> users.email |
| 3 | action | VARCHAR(50) | NO | - | 활동 유형 |
| 4 | target_type | VARCHAR(50) | YES | - | 대상 타입 |
| 5 | target_id | BIGINT | YES | - | 대상 ID |
| 6 | description | TEXT | YES | - | 상세 설명 |
| 7 | ip_address | VARCHAR(50) | YES | - | IP 주소 |
| 8 | user_agent | TEXT | YES | - | 브라우저 정보 |
| 9 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 생성일시 |

**활동 유형 (action)**
- `login`: 로그인
- `logout`: 로그아웃
- `purchase`: 구매
- `refund`: 환불
- `subscription_start`: 구독 시작
- `subscription_cancel`: 구독 취소

---

## 9. user_change_logs (유저 정보 변경 로그 테이블)

사용자 정보 변경 이력을 기록하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | id | BIGINT | NO | AUTO | 기본키 |
| 2 | user_email | VARCHAR(255) | YES | - | 유저 FK -> users.email |
| 3 | changed_field | VARCHAR(50) | NO | - | 변경된 필드명 |
| 4 | old_value | TEXT | YES | - | 이전 값 |
| 5 | new_value | TEXT | YES | - | 새 값 |
| 6 | changed_by_email | VARCHAR(255) | YES | - | 변경한 사람 FK -> users.email |
| 7 | change_reason | TEXT | YES | - | 변경 사유 |
| 8 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 생성일시 |

---

## 10. admin_logs (관리자 로그 테이블)

관리자 작업 이력을 기록하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | id | BIGINT | NO | AUTO | 기본키 |
| 2 | admin_email | VARCHAR(255) | NO | - | 관리자 FK -> users.email |
| 3 | action | VARCHAR(100) | NO | - | 작업 유형 |
| 4 | target_type | VARCHAR(50) | NO | - | 대상 타입 |
| 5 | target_id | BIGINT | YES | - | 대상 ID |
| 6 | description | TEXT | YES | - | 작업 설명 |
| 7 | ip_address | VARCHAR(50) | YES | - | IP 주소 |
| 8 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 생성일시 |

---

## 11. license_plans (라이선스 플랜 테이블)

라이선스 플랜/정책 템플릿을 정의하는 테이블 (Admin UI에서 관리)

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | id | UUID | NO | uuid_generate_v4() | 기본키 |
| 2 | product_id | UUID | NO | - | 상품 ID |
| 3 | code | VARCHAR(64) | NO | - | 플랜 코드 (Admin UI 표시용) |
| 4 | name | VARCHAR(255) | NO | - | 플랜명 |
| 5 | description | TEXT | YES | - | 플랜 설명 |
| 6 | license_type | VARCHAR(32) | NO | - | 라이선스 유형 |
| 7 | duration_days | INT | NO | - | 기본 유효기간 (일) |
| 8 | grace_days | INT | NO | 0 | EXPIRED_GRACE 유예기간 (일) |
| 9 | max_activations | INT | NO | 1 | 최대 기기 활성화 수 |
| 10 | max_concurrent_sessions | INT | NO | 1 | 최대 동시 세션 수 |
| 11 | allow_offline_days | INT | NO | 0 | 오프라인 허용 일수 |
| 12 | is_active | BOOLEAN | NO | TRUE | 활성화 여부 |
| 13 | is_deleted | BOOLEAN | NO | FALSE | 삭제 여부 (Soft Delete) |
| 14 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 생성일시 |
| 15 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 수정일시 |

**라이선스 유형 (license_type)**
- `SUBSCRIPTION`: 구독형
- `PERPETUAL`: 영구 라이선스
- `TRIAL`: 체험판

---

## 12. license_plan_entitlements (플랜 기능 권한 테이블)

플랜별 활성화 기능 목록을 정의하는 테이블

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | id | UUID | NO | uuid_generate_v4() | 기본키 |
| 2 | plan_id | UUID | NO | - | 플랜 FK -> license_plans.id |
| 3 | entitlement_key | VARCHAR(100) | NO | - | 기능 식별자 |

**기능 식별자 예시 (entitlement_key)**
- `core-simulation`: 기본 시뮬레이션
- `advanced-visualization`: 고급 시각화
- `export-reports`: 리포트 내보내기

---

## 13. licenses (라이선스 테이블)

라이선스 정보를 저장하는 테이블 (Licensing BC Aggregate Root)

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | id | UUID | NO | uuid_generate_v4() | 기본키 |
| 2 | owner_type | VARCHAR(20) | NO | - | 소유자 유형 (USER/ORG) |
| 3 | owner_id | UUID | NO | - | 소유자 ID |
| 4 | product_id | UUID | NO | - | 상품 ID |
| 5 | plan_id | UUID | YES | - | 플랜 FK -> license_plans.id |
| 6 | license_type | VARCHAR(20) | NO | - | 라이선스 유형 |
| 7 | usage_category | VARCHAR(30) | NO | - | 사용 용도 |
| 8 | status | VARCHAR(20) | NO | - | 라이선스 상태 |
| 9 | issued_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 발급일시 |
| 10 | valid_from | TIMESTAMP | NO | CURRENT_TIMESTAMP | 유효 시작일 |
| 11 | valid_until | TIMESTAMP | YES | - | 유효 종료일 |
| 12 | policy_snapshot | JSONB | YES | - | 발급 시점 정책 스냅샷 |
| 13 | license_key | VARCHAR(50) | YES | - | 라이선스 키, UNIQUE |
| 14 | source_order_id | UUID | YES | - | 원본 주문 ID |
| 15 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 생성일시 |
| 16 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 수정일시 |

**소유자 유형 (owner_type)**
- `USER`: 개인
- `ORG`: 조직

**사용 용도 (usage_category)**
- `COMMERCIAL`: 상업용
- `RESEARCH`: 연구용
- `EDUCATION`: 교육용
- `INTERNAL`: 내부평가용

**라이선스 상태 (status)**
- `PENDING`: 대기
- `ACTIVE`: 활성
- `EXPIRED_GRACE`: 유예기간
- `EXPIRED_HARD`: 완전 만료
- `SUSPENDED`: 정지
- `REVOKED`: 폐기

---

## 14. license_activations (라이선스 활성화 테이블)

기기 활성화 정보를 저장하는 테이블 (라이선스별 기기 슬롯)

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | id | UUID | NO | uuid_generate_v4() | 기본키 |
| 2 | license_id | UUID | NO | - | 라이선스 FK -> licenses.id |
| 3 | device_fingerprint | VARCHAR(255) | NO | - | 기기 식별 해시 |
| 4 | status | VARCHAR(20) | NO | - | 활성화 상태 |
| 5 | activated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 활성화 일시 |
| 6 | last_seen_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 마지막 확인 일시 |
| 7 | client_version | VARCHAR(50) | YES | - | 클라이언트 버전 |
| 8 | client_os | VARCHAR(100) | YES | - | 클라이언트 OS |
| 9 | last_ip | VARCHAR(45) | YES | - | 마지막 IP 주소 |
| 10 | offline_token | VARCHAR(2000) | YES | - | 오프라인 토큰 |
| 11 | offline_token_expires_at | TIMESTAMP | YES | - | 오프라인 토큰 만료일 |
| 12 | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 생성일시 |
| 13 | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 수정일시 |

**활성화 상태 (status)**
- `ACTIVE`: 활성
- `INACTIVE`: 비활성
- `EXPIRED`: 만료

---

## 15. revoked_offline_tokens (무효화된 오프라인 토큰 테이블)

무효화된 오프라인 토큰 목록을 저장하는 테이블 (탈취 대응)

| No | 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|----|--------|-------------|------|--------|------|
| 1 | id | UUID | NO | uuid_generate_v4() | 기본키 |
| 2 | license_id | UUID | NO | - | 라이선스 FK -> licenses.id |
| 3 | activation_id | UUID | YES | - | 활성화 ID |
| 4 | device_fingerprint | VARCHAR(255) | YES | - | 기기 식별 해시 |
| 5 | token_hash | VARCHAR(255) | NO | - | 토큰 해시 |
| 6 | revoked_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 무효화 일시 |
| 7 | reason | VARCHAR(255) | YES | - | 무효화 사유 |

---

## ERD 관계도

```
[사용자 도메인]
user_roles (1) ──────────────────────────────> users (N)
                                                  │
                     ┌────────────────────────────┼────────────────────────────┐
                     │                            │                            │
                     ▼                            ▼                            ▼
              activity_logs              user_change_logs                admin_logs
              (FK: user_email)      (FK: user_email, changed_by_email)  (FK: admin_email)

[결제 도메인]
products (1) ──────────────────────────────> price_plans (N)
    │                                             │
    │                                             │
    ▼                                             ▼
subscriptions (N:1) <─────────────────────────────┘
    │
    ▼
payments (FK: user_email_fk, subscription_id, price_plan_id)

[라이선스 도메인]
license_plans (1) ──────────────────────────> license_plan_entitlements (N)
    │
    ▼
licenses (N:1)
    │
    ├──────────────────────────> license_activations (N)
    │
    └──────────────────────────> revoked_offline_tokens (N)
```

---

## 결제 흐름

1. **유저 회원가입**: `users` 테이블에 레코드 생성
2. **이메일 인증**: `email_verifications` 테이블에서 인증 코드 관리
3. **상품 선택**: `products` + `price_plans` 조회
4. **결제 진행**: `payments` 테이블에 pending 상태로 생성
5. **토스페이먼츠 콜백**: `order_id`, `payment_key` 저장, status -> completed
6. **구독 생성**: `subscriptions` 레코드 생성
7. **라이선스 발급**: `licenses` 테이블에 라이선스 생성
8. **환불 요청**: `payments.status` -> refunded, 환불 정보 기록

---

## 라이선스 상태 흐름

```
PENDING ──────> ACTIVE ──────> EXPIRED_GRACE ──────> EXPIRED_HARD
                  │
                  │ (정지 시)
                  ▼
              SUSPENDED ──────> (복구 가능)
                  │
                  │ (폐기 시)
                  ▼
               REVOKED (복구 불가)
```
